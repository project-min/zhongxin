<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>中新生态城</title>

    <!-- Bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <!-- Font Awesome -->
    <link href="./vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="./vendors/nprogress/nprogress.css" rel="stylesheet">

    <!-- bootstrap-daterangepicker -->
    <link href="./vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>

    <!-- Custom Theme Style -->
    <link href="./build/css/custom.css" rel="stylesheet">
    
    <!-- ArcGIS css Begin -->
    <link rel="stylesheet" href="https://js.arcgis.com/3.26/dijit/themes/nihilo/nihilo.css">
    <link rel="stylesheet" type="text/css" href="http://js.arcgis.com/3.26/esri/css/esri.css">
    <!-- ArcGIS css End -->
    
    <style type="text/css">
      #wizard {
        font-size: 0.9em;
      }
    </style>
    
    <script src="https://js.arcgis.com/3.26/"></script>
  </head>

  <body class="nav-md footer_fixed">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col menu_fixed">
          <div class="left_col scroll-view">
            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3></h3>
                <ul class="nav side-menu">
                  <li><a><i class="fa fa-group"></i>人口监控分析<span class="fa fa-chevron-down"></span></a>
                  </li>
                  <li><a><i class="fa fa-wifi"></i>Wi-Fi热点分析<span class="fa fa-chevron-down"></span></a>
                  </li>
                  <li><a><i class="fa fa-comment-o"></i>公共信息发布<span class="fa fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="general_elements.html">短信发送</a></li>
                      <li><a href="media_gallery.html">日志查询</a></li>
                      <li><a href="typography.html">客群管理</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /sidebar menu -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav>
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>

              <ul class="nav navbar-nav navbar-right">
                <li class="">
                  <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    用户名
                    <span class=" fa fa-angle-down"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-usermenu pull-right">
                    <li><a href="login.html"><i class="fa fa-sign-out pull-right"></i>Log Out</a></li>
                  </ul>
                </li>

                <li role="presentation" class="dropdown">
                  <a href="javascript:;" class="dropdown-toggle info-number" data-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-bell-o"></i>
                    <span class="badge bg-green">6</span>
                  </a>
                </li>
                <li role="presentation" class="dropdown">
                  <a href="javascript:;" class="dropdown-toggle info-number" data-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-search"></i>
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main" >
          <div class="row">
            <div class="col-md-3" id="template-form">
              <div class="x_panel">
                <div id="wizard" class="form_wizard wizard_horizontal">
                  <ul class="wizard_steps" style="display: none;">
                    <li>
                      <a href="#step-1">
                        <span class="step_no">1</span>
                        <span class="step_descr">
                          第一步<br />
                          <small>客群设置</small>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a href="#step-2">
                        <span class="step_no">2</span>
                        <span class="step_descr">
                          第二步<br />
                          <small>任务创建</small>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a href="#step-3">
                        <span class="step_no">3</span>
                        <span class="step_descr">
                          第三步<br />
                          <small>内容编辑</small>
                        </span>
                      </a>
                    </li>
                    <li>
                      <a href="#step-4">
                        <span class="step_no">4</span>
                        <span class="step_descr">
                          第四步<br />
                          <small>信息确认</small>
                        </span>
                      </a>
                    </li>
                  </ul>
                  <div id="step-1">
                    <div class="x_title">
                      <h5>客群选择</h5>
                      <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                      <div style="padding: 0 0 1em 0; ">
                        <label for="target-name">客群名称：</label>
                        <div class="row">
                          <div class="col-lg-12">
                            <div class="input-group">
                              <input id="target-name" type="text" class="form-control" placeholder="Search for...">
                              <span class="input-group-btn">
                                <button id="target-search" class="btn btn-default" type="button">查找</button>
                              </span>
                            </div><!-- /input-group -->
                          </div><!-- /.col-lg-6 -->
                        </div><!-- /.row -->
                        <select id="target" class="custom-select" required></select>
                      </div>
                      <div style="padding: 0 0 1em 0; ">
                        <label for="sex">性别：</label>
                        <!-- Default inline 1-->
                        <div class="row">
                          <div class="col-lg-3">
                            <input type="radio" name="sex" value="0" checked="checked">
                            <label>全部</label>
                          </div>
                          <div class="col-lg-3">
                            <input type="radio" name="sex" value="1">
                            <label>男</label>
                          </div>
                          <div class="col-lg-3">
                            <input type="radio" name="sex" value="2">
                            <label>女</label>
                          </div>
                        </div>
                      </div>
                      <div style="padding: 0 0 1em 0; ">
                        <label for="age">年龄段：</label>
                          <select id="age" class="custom-select" required>
                            <option value="0">不限</option>
                            <option value="1">0-20</option>
                            <option value="2">21-40</option>
                            <option value="4">40-60</option>
                            <option value="8">60以上</option>
                          </select>
                      </div>
                      <div style="padding: 0 0 1em 0; ">
                        <label for="roam">外省：</label>
                        <div class="row">
                          <div class="col-lg-3">
                            <input type="radio" name="roam" value="0" checked="checked">
                            <label>否</label>
                          </div>
                          <div class="col-lg-3">
                            <input type="radio" name="roam" value="1">
                            <label>是</label>
                          </div>
                        </div>
                      </div>
                      <div style="padding: 0 0 1em 0; ">
                        <label for="resident">居住情况：</label>
                        <div class="row">
                          <div class="col-lg-12">
                            <input type="radio" name="resident" value="0" checked="checked">
                            <label>全部</label>
                          </div>
                          <div class="col-lg-12">
                            <input type="radio" name="resident" value="1">
                            <label>常驻人口</label>
                          </div>
                          <div class="col-lg-12">
                            <input type="radio" name="resident" value="2">
                            <label>非常驻人口</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div id="step-2">
                    <div class="x_title">
                      <h5>任务创建</h5>
                      <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                      <label for="task-name">任务名称：</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="task-name">
                      </div>
                      <label for="start-date">开始时间：</label>
                      <div class="input-group">
                        <input type="date" id="start-date" placeholder="YYYY-MM-DD" style="margin-right: 1em;">
                        <input type="time" id="start-time" style="margin-right: 1em;">
                      </div>
                      <label for="end-date">结束时间：</label>
                      <div class="input-group">
                        <input type="date" id="end-date" placeholder="YYYY-MM-DD" style="margin-right: 1em;">
                        <input type="time" id="end-time" style="margin-right: 1em;">
                      </div>
                      <label for="max-amount">发送频次：</label>
                      <div class="row">
                        <div class="col-lg-3">
                          <input type="radio" name="frequency" value="1" checked="" required />
                          <label>1次</label>
                        </div>
                        <div class="col-lg-3">
                          <input type="radio" name="frequency" value="2" />
                          <label>每天</label>
                        </div>
                        <div class="col-lg-4">
                          <input type="radio" name="frequency" value="3" />
                          <label>每月</label>
                        </div>
                      </div>
                      <label for="distribute">免打扰：</label>
                      <div class="row">
                        <div class="col-lg-3">
                          <input type="radio" name="distribute" value="1" checked="" required />
                          <label>1天</label>
                        </div>
                        <div class="col-lg-3">
                          <input type="radio" name="distribute" value="2" />
                          <label>7天</label>
                        </div>
                        <div class="col-lg-6">
                          <input type="radio" name="distribute" value="3" />
                          <label>30天</label>
                        </div>
                      </div>
                      <label for="max-amount">最大发送量：</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="max-amount">
                      </div>
                      
                    </div>
                  </div>
                  <div id="step-3">
                    <div class="x_title">
                      <h5>运营商</h5>
                      <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                      <div class="input-group">
                        <input type="checkbox" id="cmcc" name="operator" value="CMCC">
                        <label>中国移动</label>
                      </div>
                      <label for="max-amount">中国移动最大发送量：</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="cmcc-max-amount">
                      </div>
                      <div class="input-group">
                        <input type="checkbox" id="cucc" name="operator" value="CUCC">
                        <label>中国联通</label>
                      </div>
                      <label for="max-amount">中国联通最大发送量：</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="cucc-max-amount">
                      </div>
                    </div>
                  </div>
                  <div id="step-4">
                    <div class="x_title">
                      <h5>信息正文</h5>
                      <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                      <label for="message-title">信息标题：</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="message-title">
                      </div>
                      <label for="message-content">正文：</label>
                      <div class="input-group">
                        <textarea name="descr" id="message-content" class="form-control" rows="3"></textarea>
                      </div>
                    </div>
                  </div>
                  
                </div>
              </div>
            </div>
            <div class="col-md-9"  id="map-container">
              <div id="map">
                <button type="button" class="btn btn-default" id="map-confirm" style="position: absolute; z-index: 100; right: 25px; bottom: 15px;">加载</button>
              </div>
              
            </div>
          </div>
        </div>
        
        <div class="modal fade" id="confirm-create" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                确认信息
              </div>
              <div class="modal-body" id="confirm-message">
                
              </div>
              <div class="modal-footer">
                <button id="cancel" type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button id="confirm" type="button" class="btn btn-danger" >确定</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- /page content -->
        <div class="modal fade" tabindex="-1" role="dialog" id="error-message">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">信息</h4>
              </div>
              <div class="modal-body" id="modal-message">
                <p></p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        
        <!-- footer content -->
        <footer>
          <div class="pull-right">
            中新生态城 <a href="https://colorlib.com"></a>
          </div>
          <div class="clearfix"></div>
        </footer>
        <!-- /footer content -->
        
      </div>
    </div>

    <!-- jQuery (for Bootstrap's JavaScript plugins) -->
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <!-- Include all  plugins or individual files as needed -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    
    <!-- Flot -->
    <script src="./vendors/Flot/jquery.flot.js"></script>
    <script src="./vendors/Flot/jquery.flot.pie.js"></script>
    <script src="./vendors/Flot/jquery.flot.time.js"></script>
    <script src="./vendors/Flot/jquery.flot.stack.js"></script>
    <script src="./vendors/Flot/jquery.flot.resize.js"></script>
    <!-- Flot plugins -->
    <script src="./vendors/flot.orderbars/js/jquery.flot.orderBars.js"></script>
    <script src="./vendors/flot-spline/js/jquery.flot.spline.min.js"></script>
    <script src="./vendors/flot.curvedlines/curvedLines.js"></script>
    <!-- DateJS -->
    <script src="./vendors/DateJS/build/date.js"></script>
    
    <script src="./vendors/jQuery-Smart-Wizard/js/jquery.smartWizard.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="./build/js/custom.js"></script>
    <script src="./assets/js/main.js"></script>
    <script src="./assets/js/jquery.sha1.js"></script>
    
    <script>
      var targets = [];
      var task = new Object;
      var target = new Object;
      var groupId;
      var taskName;
      var beginDate;
      var endDate;
      var maxAmount;
      var noDistrub;
      var messageTitle;
      var messageConent;
      
      var map;
      var toolbar;

      var editToolbar;

      var arrayPolygon = [];

      require(
        ["esri/map",
         "esri/toolbars/draw",
         "esri/toolbars/edit",
         "esri/graphic",
         "esri/geometry/Polygon",
         "esri/layers/ArcGISTiledMapServiceLayer",
         "esri/geometry/Extent",
         "esri/geometry/Point",
         "esri/SpatialReference",
         "esri/symbols/SimpleFillSymbol",
         "esri/symbols/SimpleLineSymbol",
         "esri/Color",
         "esri/tasks/GeometryService",
         "esri/tasks/ProjectParameters",
         "dijit/registry",
         "dijit/Menu",
         "dijit/MenuItem",
         "dijit/MenuSeparator",
         "dijit/form/Button",
         "dojo/parser",
         "dojo/on",
         "dojo/dom",
         "dojo/domReady!"],
        function(
          Map,
          Draw,
          Edit,
          Graphic,
          Polygon,
          ArcGISTiledMapServiceLayer,
          Extent,
          Point,
          SpatialReference,
          SimpleFillSymbol,
          SimpleLineSymbol,
          Color,
          GeometryService,
          ProjectParameters,
          registry,                 
          Menu,
          MenuItem,
          MenuSeparator,
          Button,
          parser,
          on,
          dom) {
            
          parser.parse();
            
          var sr = new SpatialReference(4326);
          var ext = {"xmin":117.67255102256046,
                     "ymin":39.06648939147723,
                     "xmax":117.91507758557971,
                     "ymax":39.2233553582866};
        
          var geometryService = new GeometryService("https://utility.arcgisonline.com/ArcGIS/rest/services/Geometry/GeometryServer");

          var map = new Map("map", {
		    logo:false,//右下的esri logo
		    showAttribution:false,//右下的gisNeu (logo左侧)
            autoResize: true,
            extent: new Extent({xmin:ext.xmin,
                                ymin:ext.ymin,
                                xmax:ext.xmax,
                                ymax:ext.ymax})
          });

          var tiledLayer = new ArcGISTiledMapServiceLayer(
            "https://server.arcgisonline.com/arcgis/rest/services/World_Street_Map/MapServer", 
            { spatialReference: sr }
          );
        
          map.addLayer(tiledLayer);

          map.on("load", function() {
            //createToolbarAndContextMenu();
          });          

          on(dom.byId("map-confirm"), "click", function(evt){
            map.graphics.clean();
            drawMap(target.geoInfo);
          });
            
          //targetId = getUrlLastNumber();
          //var target = getTargetById(targetId);
          //setFormValue(target.targetName, target.serviceId, target.userInfo);
          //drawMap(target.geoInfo);
        
          function transferPolygon() {
            var convertPolygons = [];
            polygons = [];
            
            var length = map.graphics.graphics.length;

            for (var i = 0; i < length; i++) {
              var py = new Polygon(new SpatialReference(map.graphics.graphics[i].geometry.spatialReference.wkid));
              py.rings = map.graphics.graphics[i].geometry.rings;
              py.type = map.graphics.graphics[i].geometry.type;
              if (py.type.toLowerCase() == "polygon") {
                convertPolygons.push(py);
              }
            }
            if (convertPolygons.length > 0) {
              var project = geometryService.project(convertPolygons, sr, function(result) {
                for(var i = 0; i < result.length; i++) {
                  var points = []
                  for (var j = 0; j < result[i].rings[0].length; j++) {
                    var pt = new point(result[i].rings[0][j][0], result[i].rings[0][j][1]);
                    points.push(pt);
                  }
                  var pg = new graphic(points);
                  polygons.push(pg);
                }
                //console.log(polygons);
                alert("选择区域已确认");
              });
            }
            else {
              alert("选择区域为空");
            }
            //console.log(polygons);
          }

          function addToMap(evt) {
            var symbol;
            toolbar.deactivate();
            map.showZoomSlider();
            //symbol = new SimpleFillSymbol();
            symbol = new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, 
              new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([98,194,204]), 2), new Color([98,194,204,0.5])
            );
            var graphic = new Graphic(evt.geometry, symbol);

            map.graphics.add(graphic);
          }

          function drawMap(geoInfo) {
            console.log("draw poly");
            var latOffset, lonOffset, center, lat, lon, points;
            
            for (var i = 0; i < geoInfo[0].polygons.length; i ++) {
              var points = []
              var polygon = geoInfo[0].polygons[i].polygon;
              for (var j = 0; j < polygon.length; j++) {
                points.push([polygon[j].lng, polygon[j].lat]);
              }
              // Create a Green Polygon
              //var points1 = [
              //  [117.18244762388206,39.13429536101209],
              //  [117.18193264039091,39.133363288260526],
              //  [117.18094558682807,39.134062343980844],
              //  [117.18244762388206,39.13429536101209]
              //];
              drawPolygon(points);
            }
            
            
          }
            
          function drawPolygon(points) {
            var polygon = new esri.geometry.Polygon();
            polygon.addRing(points);
            polygon.spatialReference = sr;

            console.log("created poly geom");

            // Add the polygon to map
            var symbol = new esri.symbol.SimpleFillSymbol().setStyle(esri.symbol.SimpleFillSymbol.STYLE_SOLID);
            polygonGraphic = new esri.Graphic(polygon, symbol, { keeper: true });
            map.graphics.add(polygonGraphic);
            //var polyLayer = new esri.layers.GraphicsLayer({ id: "poly" });
            //map.addLayer(polyLayer);
            //polyLayer.add(polygonGraphic);
            console.log("added poly graphic");
          }
        
          function createToolbarAndContextMenu() {
            toolbar = new Draw(map);
            toolbar.on("draw-end", addToMap);
            
            // Create and setup editing tools
            editToolbar = new Edit(map);

            map.on("click", function(evt) {
              editToolbar.deactivate();
            });

            createMapMenu();
            createGraphicsMenu();
          }

          function createMapMenu() {
            // Creates right-click context menu for map
            var ctxMenuForMap = new Menu({
              onOpen: function(box) {
                // Lets calculate the map coordinates where user right clicked.
                // We'll use this to create the graphic when the user clicks
                // on the menu item to "Add Point"
                currentLocation = getMapPointFromMenuPosition(box);          
                editToolbar.deactivate();
              }
            });

            ctxMenuForMap.addChild(new MenuItem({ 
              label: "新区域",
              onClick: function() {
                toolbar.activate(Draw["POLYGON"]);
                map.hideZoomSlider();
              }
            }));

            ctxMenuForMap.startup();
            ctxMenuForMap.bindDomNode(map.container);
          }

          function createGraphicsMenu() {
            // Creates right-click context menu for GRAPHICS
            var ctxMenuForGraphics = new Menu({});
            ctxMenuForGraphics.addChild(new MenuItem({ 
              label: "编辑",
              onClick: function() {
                if ( selected.geometry.type !== "point" ) {
                  editToolbar.activate(Edit.EDIT_VERTICES, selected);
                } else {
                  alert("Not implemented");
                }
              } 
            }));

            ctxMenuForGraphics.addChild(new MenuItem({ 
              label: "移动",
              onClick: function() {
                editToolbar.activate(Edit.MOVE, selected);
              } 
            }));
          
            ctxMenuForGraphics.addChild(new MenuSeparator());
            ctxMenuForGraphics.addChild(new MenuItem({ 
              label: "删除",
              onClick: function() {
                map.graphics.remove(selected);
              }
            }));

            ctxMenuForGraphics.startup();

            map.graphics.on("mouse-over", function(evt) {
              // We'll use this "selected" graphic to enable editing tools
              // on this graphic when the user click on one of the tools
              // listed in the menu.
              selected = evt.graphic;

              // Let's bind to the graphic underneath the mouse cursor           
              ctxMenuForGraphics.bindDomNode(evt.graphic.getDojoShape().getNode());
            });

            map.graphics.on("mouse-out", function(evt) {
              ctxMenuForGraphics.unBindDomNode(evt.graphic.getDojoShape().getNode());
            });
          }

          function getMapPointFromMenuPosition(box) {
            var x = box.x, y = box.y;
            switch( box.corner ) {
              case "TR":
                x += box.w;
                break;
              case "BL":
                y += box.h;
                break;
              case "BR":
                x += box.w;
                y += box.h;
                break;
            }

            var screenPoint = new Point(x - map.position.x, y - map.position.y);
            return map.toMap(screenPoint);
          }
        }
      );

      $(document).ready(function () {
        var now = new Date();
        var endday = ("0" + now.getDate()).slice(-2);
        var endmonth = ("0" + (now.getMonth() + 1)).slice(-2);
        var day2 = now.getFullYear()+"-"+(endmonth)+"-"+(endday);
        $('#end-date').val(day2);
        
        var starttime = now.addDays(-7);
         
        var startday = ("0" + starttime.getDate()).slice(-2);
        var startmonth = ("0" + (starttime.getMonth() + 1)).slice(-2);
        var day1 = starttime.getFullYear()+"-"+(startmonth)+"-"+(startday) ;
        
        $('#start-date').val(day1);
        
        var time1 = now.getHours() + ":" + now.getMinutes();
        $('#start-time').val(time1);
        $('#end-time').val(time1);
        
        init_SmartWizard();
        
        /*var options={
          format: 'yyyy-mm-dd',
          container: $('#step-2 div.x_content'),
          todayHighlight: true,
          autoclose: true,
        };
        $('#start-date').datepicker(options);
        $('#end-date').datepicker(options);*/
        
        $('#target-search').click(function() {
          buildTargetList();
        });
        
        $("input:checkbox[name=CMCC]").prop("checked", true);  
        $("input:checkbox[name=CUCC]").prop("checked", true);
        
        $('#target').change(function() {
          var targetId = $(this).children('option:selected').val();
          getTargetById(targetId);
          setFormValue(target.userInfo);
          
          $('#map-confirm').trigger("click");
          /*var length = targets.length;
          for (var i = 0; i < length; i ++) {
            if (targets[i].targetID == targetId) {
              var userInfo = targets[i].userInfo;
              setFormValue(userInfo);
            }
          }*/
        });
        
        $('#confirm').click(function() {
          $('#confirm-create').modal('hide');
          createTask(task);
        });
        
      });

      /* SMART WIZARD */
      function init_SmartWizard() {
			
        if( typeof ($.fn.smartWizard) === 'undefined'){ return; }
        $('#wizard').smartWizard({
          labelNext: '下一步',
          labelPrevious: '上一步',
          labelFinish: '发布',
          onLeaveStep:leaveAStepCallback,
          onFinish:onFinishCallback});

        $('.buttonNext').addClass('btn btn-success');
        $('.buttonPrevious').addClass('btn btn-primary');
        $('.buttonFinish').addClass('btn btn-default');
      };
      
      function leaveAStepCallback(obj, context){
        var frequencyRange = [1, 2, 3];
        var distributeRange = [1, 2, 3];
        
        if (context.fromStep == 1) {
          return checkStep1();
        }
        if (context.fromStep == 2) {
          return checkStep2();
          
        }
        if (context.fromStep == 3) {
          return checkStep3();
        }
        if (context.fromStep == 4) {
          return checkStep4();
        }
        return true; // return false to stay on step and true to continue navigation 
      }

      function onFinishCallback(objs, context){
        if (!checkStep1()) return;
        if (!checkStep2()) return;
        if (!checkStep3()) return;
        if (!checkStep4()) return;
        var message = buildConfirmMessage();
        $('#confirm-message').empty();
        $('#confirm-message').append(message);
        $('#confirm-create').modal();
      }
      
      function validateAllSteps(){
        var isStepValid = true;
        // all step validation logic     
        return isStepValid;
      }
      
      function checkStep1() {
        var targetId = parseInt($('#target').children('option:selected').val());
        if (targetId > 0) {
          task.targetID = targetId;
          return true;
        }
        else{
          showMessage("请选择客群");
          return false;
        }
      }
      
      function checkStep2() {
        var errorMessage = '';
        var distributeRange = [1, 2, 3];
        var frequencyRange = [1, 2, 3];
        var taskName = $('#task-name').val();
        var strStartDate = $('#start-date').val();
        var strStartTime = $('#start-time').val();
        var strEndDate = $('#end-date').val();
        var strEndTime = $('#end-time').val();
        var strMaxAmount = $('#max-amount').val();
        var strDistribute = $("input[name='distribute']:checked").val();
        var strFrequency = $("input[name='frequency']:checked").val();

        if (taskName.length <= 0) {
          errorMessage += "<p>任务名称不能为空；</p>";
        }

        var maxAmount = parseInt(strMaxAmount);
        if (isInteger(maxAmount)) {
          if (maxAmount < 0) {
            errorMessage += "<p>最大发送条数错误；</p>";
          }
        }
        else {
          errorMessage += "<p>最大发送条数错误；</p>";
        }

        var distribute = parseInt(strDistribute);
        if (!distributeRange.in_array(distribute)) {
          errorMessage += "<p>免打扰选择发生错误；</p>";
        }

        var frequency = parseInt(strFrequency);
        if (!frequencyRange.in_array(frequency)) {
          errorMessage += "<p>发送频次选择发生错误；</p>";
        }

        startTime = getFormatJsonTime(strStartDate, strStartTime);
        endTime = getFormatJsonTime(strEndDate, strEndTime);

        if (startTime == '') {
          errorMessage += "<p>开始日期时间发生错误；</p>";
        }

        if (endTime == '') {
          errorMessage += "<p>开始日期时间发生错误；</p>";
        }

        if (errorMessage.length > 0) {
          $('#modal-message').empty();
          $('#modal-message').append(errorMessage);
          $('#error-message').modal();
          return false;
        }
        else {
          task.taskName = taskName;
          task.starttime = startTime;
          task.endtime = endTime;
          task.max = maxAmount;
          task.distribute = distribute;
          task.frequency = frequency;
          return true;
        }
      }
      
      function checkStep3() {
        var errorMessage = '';
        var strCMCCMaxAmount = $('#cmcc-max-amount').val();
        var strCUCCMaxAmount = $('#cucc-max-amount').val();

        var cmccMaxAmount = 0
        if($("input:checkbox[name=CMCC]").is(':checked')){
          cmccMaxAmount = parseInt(strCMCCMaxAmount);
          if (isInteger(cmccMaxAmount)) {
            if (cmccMaxAmount < 0) {
              errorMessage += "<p>移动最大发送条数错误；</p>";
            }
          }
          else {
            errorMessage += "<p>移动最大发送条数错误；</p>";
          }
        }

        var cuccMaxAmount = 0;
        if($("input:checkbox[name=CUCC]").is(':checked')){

          cuccMaxAmount = parseInt(strCUCCMaxAmount);
          if (isInteger(cuccMaxAmount)) {
            if (cuccMaxAmount < 0) {
              errorMessage += "<p>联通最大发送条数错误；</p>";
            }
          }
          else {
            errorMessage += "<p>联通最大发送条数错误；</p>";
          }
        }

        if (errorMessage.length > 0) {
          $('#modal-message').empty();
          $('#modal-message').append(errorMessage);
          $('#error-message').modal();
          return false;
        }
        else {
          services = [];
          cmccService = new Object;
          cmccService.senderId = 1;
          cmccService.max = cmccMaxAmount;
          services.push(cmccService);

          cuccService = new Object;
          cuccService.senderId = 2;
          cuccService.max = cuccMaxAmount;
          services.push(cuccService);

          task.senderInfo = services;
          return true;
        }
      }
      
      function checkStep4() {
        var errorMessage = '';
        var messageTitle = $('#message-title').val();
        var messageContent = $('#message-content').val();
        if (messageTitle.length <= 0) {
          errorMessage += "<p>短信标题不能为空；</p>";
        }

        if (messageContent.length <= 0) {
          errorMessage += "<p>短信正文不能为空；</p>";
        }
        if (errorMessage.length > 0) {
          $('#modal-message').empty();
          $('#modal-message').append(errorMessage);
          $('#error-message').modal();
          return false;
        }
        else {
          var content = {
            'title': messageTitle,
            'text': messageContent
          }
          task.content = content;
          
          return true;
        }
      }
      
      function buildConfirmMessage() {
        var content = "<p>客群名称：" + $('#target-name').val() + "</p>";
        content += "<p>年龄段：" + $('#age').val() + "</p>";
        
        var strResident = $("input[name='resident']:checked").val();
        var resident = "全部";
        if (strResident == '2') {
          resident = "是";
        }
        if (strResident == '3') {
          resident = "否";
        }
        
        var strDistribute = $("input[name='distribute']:checked").val();
        var distribute = "1天";
        if (strDistribute == '2') {
          resident = "7天";
        }
        if (strDistribute == '3') {
          resident = "30天";
        }
        
        content += "<p>居住情况：" + resident + "</p>";
        content += "<p>任务名称：" + task.taskName + "</p>";
        content += "<p>开始时间：" + $('#start-date').val() + " " + $('#start-time').val() + "</p>";
        content += "<p>结束时间：" + $('#end-date').val() + " " + $('#end-time').val() + "</p>";
        content += "<p>最大发送量：" + $('#max-amount').val() + "</p>";
        content += "<p>免打扰：" + distribute + "</p>";
        content += "<p>信息标题：" + $('#message-title').val() + "</p>";
        content += "<p>正文内容：" + $('#message-content').val() + "</p>";
        return content;
      }
      
      function retrieveTargetSuccessProcess(result) {
        var list = result.data.targetlist;
        $('#datatable tbody').empty();
        var length = list.length;
        targets = [];
        if (length > 0) {
          for (var i = 0; i <= length - 1; i++) {
            targets.push(list[i]);
            var content = "<option value=\"" + list[i].targetID + "\">" + list[i].targetName + "</option>";
            $('#target').append(content);
          }
          
          getTargetById(list[0].targetID);
          setFormValue(list[0].userInfo);
          $('#map-confirm').trigger("click");
        }
        else {
          showMessage("未找到相关客群信息");
        }
      }
      
      function retrieveTargetFailedProcess(result) {
        showMessage(result.errmsg);
      }
      
      function buildTargetList() {
        $('#target').empty();
        var name = $('#target-name').val();
        
        var query = new Object;
        query.targetname = name;
        
        var body = JSON.stringify(query);
        var userId = getCookie('userId');
        var clientId = getCookie('clientId');
        var token = getCookie('token');
        var header = new AjaxHeader(userId, clientId, body, token);
        
        callAjax('http://127.0.0.1:8000/ajax/target/search/', header, body, retrieveTargetSuccessProcess, retrieveTargetFailedProcess);
        /*$.ajax({
          type: 'post',
          url:'http://127.0.0.1:8000/ajax/target/search/',
          dataType: 'json',
          data: body,
          beforeSend: function(xhr) {
            setAjaxHeader(xhr, header);
          },
          async: false,
          success: function(result) {
            if (result.errcode >= 0) {
              var list = result.data.targetlist;
              $('#datatable tbody').empty();
              var length = list.length;
              targets = [];
              if (length > 0) {
                for (var i = 0; i <= length - 1; i++) {
                  targets.push(list[i]);
                  var content = "<option value=\"" + list[i].targetID + "\">" + list[i].targetName + "</option>";
                  $('#target').append(content);
                }
                var userInfo = list[0].userInfo;
                setFormValue(userInfo);
              }
              else {
                showMessage("未找到相关客群信息");
              }
            }
            else {
              showMessage(result.errmsg);
            }
          },
          error: function (XMLHttpRequest, textStatus, errorThrown) {
            var message = "<p>信息提交过程发生异常，请与管理员联系</p>"
            message += "<p>状态码：" + XMLHttpRequest.status + "</p>"
            message += "<p>状态：" + XMLHttpRequest.readyState + "</p>"
            message += "<p>异常信息：" + textStatus + "</p>"
            showMessage(message);
          }
        });*/
      }
      
      function setFormValue(userInfo) {
        $("input:checkbox[name=CMCC]").prop("checked", false);
        $("input:checkbox[name=CUCC]").prop("checked", false);
                
        $("input[name='sex'][value='" + userInfo.sex + "']").prop("checked",true);
        $("input[name='roam'][value='" + userInfo.roam + "']").prop("checked",true);
        $("input[name='resident'][value='" + userInfo.resident + "']").prop("checked",true);
        
      }
      
      function createTaskSuccessProcess(result) {
        var message = "<p>新任务信息已提交</p>";
        message += "<p>新任务信息已保存</>";
        showMessage(result.errmsg);
      }
      
      function createTaskFailedProcess(result) {
        var message = "<p>新任务信息已提交</p>";
        message += "<p>新任务信息保存失败</p>"
        message += "<p>";
        message += result.errmsg;
        message += "</>";
        showMessage(result.errmsg);
      }
      
      function createTask() {
        if (target != null) {
          var body = JSON.stringify(task);
          var userId = getCookie('userId');
          var clientId = getCookie('clientId');
          var token = getCookie('token');
          var header = new AjaxHeader(userId, clientId, body, token);
          
          callAjax('http://127.0.0.1:8000/ajax/task/create/', header, body, createTaskSuccessProcess, createTaskFailedProcess);
          /*$.ajax({
            type: 'post',
            url: 'http://127.0.0.1:8000/ajax/task/create/',
            dataType: 'json',
            data: body,
            beforeSend: function(xhr) {
              setAjaxHeader(xhr, header);
            },
            success: function(result) {
              var message = "<p>新任务信息已提交</p>"
              if (result.errcode >= 0) {
                message += "<p>新任务信息已保存</>"
              }
              else {
                message += "<p>新任务信息保存失败</p>"
                message += "<p>";
                message += result.errmsg;
                message += "</>"
              }
              showMessage(result.errmsg);
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
              var message = "<p>信息提交过程发生异常，请与管理员联系</p>"
              message += "<p>状态码：" + XMLHttpRequest.status + "</p>"
              message += "<p>状态：" + XMLHttpRequest.readyState + "</p>"
              message += "<p>异常信息：" + textStatus + "</p>"
              showMessage(message);
            }
          });*/
        }
      }
      
      function retrieveTargetByIdSuccessProcess(result) {
        var data = result.data;
        target.serviceId = data.serviceID;
        target.targetName = data.targetName;
        target.createTime = data.createTime;
        target.geoInfo = data.geoInfo;
        target.userInfo = data.userInfo;
      }
      
      function retrieveTargetByIdFailedProcess(result) {
        showMessage(result.errmsg);
      }
      
      function getTargetById(targetId) {
        var t = new Object;
        var query = new Object;
        
        query.targetID = targetId.toString();
        var body = JSON.stringify(query);
        var userId = getCookie('userId');
        var clientId = getCookie('clientId');
        var token = getCookie('token');
        var header = new AjaxHeader(userId, clientId, body, token);
        
        callAjax('http://127.0.0.1:8000/ajax/target/detail/', header, body, retrieveTargetByIdSuccessProcess, retrieveTargetByIdFailedProcess)
        /*$.ajax({
          type: 'post',
          url: 'http://127.0.0.1:8000/ajax/target/detail/',
          dataType: 'json',
          data: body,
          beforeSend: function(xhr) {
            setAjaxHeader(xhr, header);
          },
          async: false,
          success: function(result) {
            if (result.errcode >= 0) {
              var data = result.data;
              t.serviceId = data.serviceID;
              t.targetName = data.targetName;
              t.createTime = data.createTime;
              t.geoInfo = data.geoInfo;
              t.userInfo = data.userInfo;
            }
            else {
              showMessage(result.errmsg);
            }
          },
          error: function (XMLHttpRequest, textStatus, errorThrown) {
            var message = "<p>信息提交过程发生异常，请与管理员联系</p>"
            message += "<p>状态码：" + XMLHttpRequest.status + "</p>"
            message += "<p>状态：" + XMLHttpRequest.readyState + "</p>"
            message += "<p>异常信息：" + textStatus + "</p>"
            showMessage(result.errmsg);
          }
        });
        
        return t;*/
      }

    </script>
    
  </body>
</html>