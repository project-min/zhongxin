<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>中新生态城</title>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css" rel="stylesheet" media="screen">
    <link href="./assets/css/font-awesome.min.css" rel="stylesheet">
    <link href="./assets/css/custom.css" rel="stylesheet">
    
    <style type="text/css">

    </style>
    
  </head>

  <body class="nav-md">
    <div class="container body">
      <div class="main_container">
        <div class="col-md-3 left_col menu_fixed">
          <div class="left_col scroll-view">
            <!-- sidebar menu -->
            <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
              <div class="menu_section">
                <h3></h3>
                <ul class="nav side-menu">
                  <li><a><i class="fa fa-group"></i>人口监控分析<span class="fa fa-chevron-down"></span></a>
                  </li>
                  <li><a><i class="fa fa-wifi"></i>WiFi热点分析<span class="fa fa-chevron-down"></span></a>
                  </li>
                  <li><a><i class="fa fa-comment-o"></i>公共信息发布<span class="fa fa-chevron-down"></span></a>
                    <ul class="nav child_menu">
                      <li><a href="task_create_zx.html">短信发送</a></li>
                      <li><a href="task_zx.html">日志查询</a></li>
                      <li><a href="target_zx.html">客群管理</a></li>
                    </ul>
                  </li>
                </ul>
              </div>
            </div>
            <!-- /sidebar menu -->
          </div>
        </div>

        <!-- top navigation -->
        <div class="top_nav">
          <div class="nav_menu">
            <nav>
              <div class="nav toggle">
                <a id="menu_toggle"><i class="fa fa-bars"></i></a>
              </div>

              <ul class="nav navbar-nav navbar-right">
                <li class="">
                  <a href="javascript:;" class="user-profile dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                    用户名
                    <span class=" fa fa-angle-down"></span>
                  </a>
                  <ul class="dropdown-menu dropdown-usermenu pull-right">
                    <li><a id="logout"><i class="fa fa-sign-out pull-right"></i>退出登录</a></li>
                  </ul>
                </li>
              </ul>
            </nav>
          </div>
        </div>
        <!-- /top navigation -->

        <!-- page content -->
        <div class="right_col" role="main" >
          <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
              <div class="x_panel">
                <div class="x_title">
                  <h5>任务管理</h5>
                  <div class="clearfix"></div>
                </div>
                <div class="x_content">
                  <div class="col-lg-3">
                    <a class="btn btn-primary" href="task_create_zx.html" role="button">新建</a>
                  </div><!-- /input-group -->
                
                  <div class="col-lg-9">
                    <div class="input-group" >
                      <input type="radio" name="status" value="0" checked="checked">
                      <label>不限</label>
                      <input type="radio" name="status" value="1">
                      <label>正在执行</label>
                      <input type="radio" name="status" value="100">
                      <label>执行完毕</label>
                      <input type="radio" name="status" value="-1">
                      <label>已取消</label>
                      <input type="date" id="end-date" placeholder="YYYY-MM-DD" style="float: right; margin-right: 1em;">
                      <input type="date" id="start-date" placeholder="YYYY-MM-DD" style="float: right; margin-right: 1em;">
                      <span class="input-group-btn">
                        <button id="search" class="btn btn-default" type="button" style="float: right">查询</button>
                      </span>
                    </div><!-- /input-group -->
                  </div><!-- /.col-lg-6 -->
                  <table id="datatable" class="table table-striped table-bordered col-lg-12">
                    <thead>
                      <tr>
                        <th>创建时间</th>
                        <th>任务名称</th>
                        <th>客群名称</th>
                        <th>信息标题</th>
                        <th>执行状态</th>
                        <th>已发送条数</th>
                        <th>已发送用户</th>
                        <th>开始发送时间</th>
                        <th>完成时间</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>
                      
                    </tbody>
                  </table>

                  <!--
                  <nav aria-label="Page navigation">
                    <ul class="pagination">
                      <li>
                        <a href="#" aria-label="Previous">
                          <span aria-hidden="true">&laquo;</span>
                        </a>
                      </li>
                      <li><a href="#">1</a></li>
                      <li><a href="#">2</a></li>
                      <li><a href="#">3</a></li>
                      <li><a href="#">4</a></li>
                      <li><a href="#">5</a></li>
                      <li>
                        <a href="#" aria-label="Next">
                          <span aria-hidden="true">&raquo;</span>
                        </a>
                      </li>
                    </ul>
                  </nav>-->
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- /page content -->
        
        <div class="modal fade" id="confirm-cancel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                确认取消
              </div>
              <div class="modal-body">
                确认取消后该任务将无法恢复 
              </div>
              <div class="modal-footer">
                <button id="cancel" type="button" class="btn btn-default" data-dismiss="modal">返回</button>
                <button id="confirm" type="button" class="btn btn-danger" >取消任务</a>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modal fade" tabindex="-1" role="dialog" id="error-message">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">信息</h4>
              </div>
              <div class="modal-body" id="modal-message">
                <p></p>
              </div>
              <div class="modal-footer">
                <button id="close-modal" type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->
        
        <!--
        <footer>
          <div class="pull-right">
            中新生态城 <a href="https://colorlib.com"></a>
          </div>
          <div class="clearfix"></div>
        </footer>
        -->
        
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="./assets/js/date.js"></script>
    
    <script src="./assets/js/custom.js"></script>
    <script src="./assets/js/main.js"></script>
    <script src="./assets/js/jquery.sha1.js"></script>

    <script>
      var cancelTaskId = 0;
      
      $(document).ready(function () {
        var now = new Date();
        var endday = ("0" + now.getDate()).slice(-2);
        var endmonth = ("0" + (now.getMonth() + 1)).slice(-2);
        var day2 = now.getFullYear()+"-"+(endmonth)+"-"+(endday);
        $('#end-date').val(day2);
        
        var starttime = now.addDays(-7);
         
        var startday = ("0" + starttime.getDate()).slice(-2);
        var startmonth = ("0" + (starttime.getMonth() + 1)).slice(-2);
        var day1 = starttime.getFullYear()+"-"+(startmonth)+"-"+(startday) ;
        
        $('#start-date').val(day1);
        
        $('#search').click(function() {
          refreshTable();
        });
        
        $(document).on("click", "#datatable button", function () {
          var name = this.name.toLowerCase();
          var id = parseInt(this.value);
          
          if (name == 'cancel') {
            cancelTaskId = id;
            $('#confirm-cancel').modal();
          }
        });
        
        $('#confirm').click(function() {
          $('#confirm-cancel').modal('hide');
          cancelTask(cancelTaskId);
          cancelTaskId = 0;
          refreshTable();
        });
        
        $('#cancel').click(function() {
          cancelTaskId = 0;
        });
      });
      
      function retrieveTaskCallBackProcess(result) {
        if (result.errcode >= 0) {
          var list = result.data.taskList;
          buildTable(list);
        }
        else {
          showMessage(result.errmsg);
        }
      }

      function refreshTable() {
        var starttime = getFormatJsonStartTime($('#start-date').val());
        var endtime = getFormatJsonEndTime($('#end-date').val());
        var strStatus = $("input[name='status']:checked").val();
        var status = parseInt(strStatus);
        var validStatusList = [0, 1, 100, -1];
        
        if (starttime.length >0 && endtime.length > 0 && validStatusList.in_array(status)) {
          var status = parseInt(strStatus);
          var query = new Object;
          query.starttime = starttime;
          query.endtime = endtime;
          query.status = status;
        
          var body = JSON.stringify(query);
          var userId = getCookie('userId');
          var clientId = getCookie('clientId');
          var token = getCookie('token');
          var header = new AjaxHeader(userId, clientId, body, token);
          
          var url = baseUrl + 'taskLists';
        
          callAjax(url, header, body, retrieveTaskCallBackProcess);
        }
        else {
          showMessage("请选择状态和查询日期");
        }
      }

      function cancelTaskCallBackProcess(result) {
        var message = "<p>取消任务信息已提交</p>";
        if (result.errcode >= 0) {
          message += "<p>任务已取消</>";
        }
        else {
          message += "<p>任务取消失败</p>"
          message += "<p>";
          message += result.errmsg;
          message += "</>"
        }
        showMessage(message);
      }
      
      function cancelTask(id) {
        $('#modal-message').empty();
        var task = new Object;
        task.taskID = id.toString();
        var body = JSON.stringify(task);
        var userId = getCookie('userId');
        var clientId = getCookie('clientId');
        var token = getCookie('token');
        var header = new AjaxHeader(userId, clientId, body, token);
        var url = baseUrl + 'taskCancel';
        
        callAjax(url, header, body, cancelTaskCallBackProcess)
      }
      
      function buildTable(tasks) {
        $('#datatable tbody').empty();
        for (var i = 0; i <= tasks.length - 1; i++){
          var status = formatTaskStatus(tasks[i].status);
          var content = "<tr>";
          content += "<td>" + getFormatDateTime(tasks[i].createTime) + "</td>";
          content += "<td>" + tasks[i].taskName + "</td>";
          content += "<td>" + tasks[i].targetName + "</td>";
          content += "<td>" + tasks[i].title + "</td>";
          content += "<td>" + status + "</td>";
          content += "<td style='text-align: right;'>" + tasks[i].totalSend + "</td>";
          content += "<td style='text-align: right;'>" + tasks[i].totalUser + "</td>";
          content += "<td>" + getFormatDateTime(tasks[i].execTime) + "</td>";
          content += "<td>" + getFormatDateTime(tasks[i].finishTime) + "</td>";
          content += "<td style=\"padding: 0.25em 1em; margin: 0;\">";
          if (tasks[i].status != -1) {
            content += "<button type=\"button\" class=\"btn btn-primary btn-sm active\" name=\"cancel\" value=\"" + tasks[i].taskID + "\" role=\"button\" aria-pressed=\"true\" style=\"margin: 0;\">取消</a>";
          }
          content += "</td>";
          content += "</tr>";
          $('#datatable tbody').append(content);
        }
      }
    </script>
  </body>
</html>